#+TITLE: ARCHAOS
#+DESCRIPTION: A post-installation script to install Deivi's desktop on an Arch-based distro.
#+AUTHOR: David Gonzalez
#+PROPERTY: header-args :tangle archaos
#+STARTUP: showeverything

* TABLE OF CONTENTS :toc:
- [[#about-archaos][About ARCHAOS]]
- [[#installing-archaos][Installing ARCHAOS]]
  - [[#installation-instructions][Installation instructions]]
- [[#updating-archaos][Updating ARCHAOS]]
- [[#check-that-user-is-not-root][Check that user is NOT root!]]
- [[#a-function-for-errors][A function for errors]]
- [[#sync-the-repos-and-install-dialog][Sync the repos and install 'dialog']]
- [[#welcome-message][Welcome message]]
- [[#asking-user-to-confirm-choice-to-install-archaos][Asking user to confirm choice to install ARCHAOS.]]
- [[#install-the-packages-from-repositories][Install the packages from repositories]]
- [[#copy-configs-over-from-etcarchaos-into-home][Copy configs over from /etc/archaos into $HOME]]
- [[#install-doom-emacs][Install Doom Emacs]]
- [[#message-stating-that-the-installation-is-complete][Message stating that the installation is complete!]]

* About ARCHAOS
#+CAPTION: ARCHAOS Scrot
#+ATTR_HTML: :alt ARCHAOS scrot :title ARCHAOS Scrot :align left
[[https://i.imgur.com/LunUaax.jpg]]

ARCHAOS is my own post-installation script. It deploys my WMs and configs. ARCHAOS should work on Arch Linux or any Arch-based distribution. ARCHAOS is only for x86_64 architecture and will not work on ARM devices such as the Raspberry Pi.

* Installing ARCHAOS
** Installation instructions
To install ARCHAOS, you need to clone this repository and run the ~archaos~ script.
#+begin_example
git clone https://github.com/deivi98/archaos
cd archaos/
./archaos
#+end_example

* Updating ARCHAOS
ARCHAOS is updated in the standard way as all Arch-based Linux distros:
#+begin_example
sudo pacman -Syu
#+end_example

Many ARCHAOS packages are configuration files. Those packages install their config files to /etc/archaos since we don't want to overwrite your config files accidentally.  If you want to use the updated configs, then you need to manually copy the configs from /etc/archaos into $HOME.

* Check that user is NOT root!
Don't run this script as root!  This is done for safety reasons.  This script makes a lot of changes to the $HOME of the $USER of this script.  For obvious reasons, we want $USER to not be 'root' and $HOME not to be '/root'.  Instead, run this script as a normal user.  You will be asked to enter a sudo password at several points during the installation.

#+begin_src bash
if [ "$(id -u)" = 0 ]; then
    echo "##################################################################"
    echo "This script MUST NOT be run as root user since it makes changes"
    echo "to the \$HOME directory of the \$USER executing this script."
    echo "You will be asked for a sudo password when necessary."
    echo "##################################################################"
    exit 1
fi
#+end_src

* A function for errors
#+begin_src bash
error() { \
    clear; printf "ERROR:\\n%s\\n" "$1" >&2; exit 1;
}
#+end_src

* Sync the repos and install 'dialog'
#+begin_src bash
echo "################################################################"
echo "## Syncing the repos and installing 'dialog' if not installed ##"
echo "################################################################"
sudo pacman --noconfirm --needed -Syu dialog || error "Error syncing the repos."
#+end_src

* Welcome message
#+begin_src bash
welcome() { \
    dialog --colors --title "\Z7\ZbInstalling ARCHAOS!" --msgbox "\Z4This script will install all Deivi's packages and dotfiles." 16 60

    dialog --colors --title "\Z7\ZbStay near your computer!" --yes-label "Continue" --no-label "Exit" --yesno "\Z4This script is not allowed to be run as root, but you will be asked to enter your sudo password at various points during this installation. This is to give PACMAN the necessary permissions to install the software.  So stay near the computer." 8 60
}

welcome || error "User choose to exit."
#+end_src

* Asking user to confirm choice to install ARCHAOS.
#+begin_src bash
lastchance() { \
    dialog --colors --title "\Z7\ZbInstalling ARCHAOS!" --msgbox "\Z4WARNING! The ARCHAOS installation script is currently in public beta testing. There are almost certainly errors in it; therefore, it is strongly recommended that you not install this on production machines. It is recommended that you try this out in either a virtual machine or on a test machine." 16 60

    dialog --colors --title "\Z7\ZbAre You Sure You Want To Do This?" --yes-label "Begin Installation" --no-label "Exit" --yesno "\Z4Shall we begin installing ARCHAOS?" 8 60 || { clear; exit 1; }
}

lastchance || error "User choose to exit."
#+end_src



* Install the packages from repositories
All packages listed are either in the standard Arch repos. All of these will be installed using pacman.

=NOTE:= The '--ask 4' option is an undocumented option for pacman that can be found in pacman's source code (in pacman's alpm.h).  Adding this flags means that all questions about removing packages that are conflicts will automatically be answered YES.

#+begin_src bash
# Let's install each package listed in the archaos.pkgs file.
sudo pacman --needed --ask 4 -Sy - < archaos.pkgs
#+end_src

* Copy configs over from /etc/archaos into $HOME
While it would be easier to make packages that could install ARCHAOS configs directly to the appropriate places in the $HOME folder, pacman does not allow for this.  Pacman is not allowed to touch $HOME ever!  The better way to do this is to install the configs in /etc/skel which is the standard directory to place such config files, but on many distros (for ex. Manjaro and Arco) /etc/skel is already used to store the distro's own config files.  So to avoid conflicts, all ARCHAOS configs are placed in /etc/archaos and then copied over to $HOME.  A backup of config is created.  BEWARE!

=NOTE:= The /etc/archaos directory contains files and directories that are automatically copied over to a new user's home directory when such user is created by the 'useradd' or the 'adduser' program, depending on your Linux distro.
#+begin_src bash
echo "################################################################"
echo "## Copying ARCHAOS configuration files from /etc/archaos into \$HOME ##"
echo "################################################################"
[ ! -d /etc/archaos ] && sudo mkdir /etc/archaos
[ -d /etc/archaos ] && mkdir ~/archaos-backup-$(date +%Y.%m.%d-%H%M) && cp -Rf /etc/archaos ~/archaos-backup-$(date +%Y.%m.%d-%H%M)
[ ! -d ~/.config ] && mkdir ~/.config
[ -d ~/.config ] && mkdir ~/.config-backup-$(date +%Y.%m.%d-%H%M) && cp -Rf ~/.config ~/.config-backup-$(date +%Y.%m.%d-%H%M)
cd /etc/archaos && cp -Rf . ~ && cd -
#+end_src

#+begin_src bash
# Change all scripts in .local/bin to be executable.
find $HOME/.local/bin -type f -print0 | xargs -0 chmod 775
#+end_src

* Install Doom Emacs
#+begin_src bash
# echo "#########################################################"
# echo "## Installing Doom Emacs. This may take a few minutes. ##"
# echo "#########################################################"
# [ -d ~/.emacs.d ] && mv ~/.emacs.d ~/.emacs.d.bak.$(date +"%Y%m%d_%H%M%S")
# [ -f ~/.emacs ] && mv ~/.emacs ~/.emacs.bak.$(date +"%Y%m%d_%H%M%S")
# git clone --depth 1 https://github.com/hlissner/doom-emacs ~/.emacs.d
# ~/.emacs.d/bin/doom install
# ~/.emacs.d/bin/doom sync
#+end_src







* Message stating that the installation is complete!
#+begin_src bash
echo "##############################"
echo "## ARCHAOS has been installed! ##"
echo "##############################"

while true; do
    read -p "Do you want to reboot to get your archaos? [Y/n] " yn
    case $yn in
        [Yy]* ) reboot;;
        [Nn]* ) break;;
        "" ) reboot;;
        * ) echo "Please answer yes or no.";;
    esac
done
#+end_src
